# CÃ i thÆ° viá»‡n cáº§n thiáº¿t (náº¿u chÆ°a cÃ³)
!pip install scikit-learn pandas joblib

# Import
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score, classification_report
from sklearn.preprocessing import LabelEncoder
import joblib

# Táº£i dataset tá»« URL
url = "heart.csv"
df = pd.read_csv(url)

# Kiá»ƒm tra cáº¥u trÃºc cá»§a dataset
print("ğŸ“Š ThÃ´ng tin vá» dataset:")
print("KÃ­ch thÆ°á»›c:", df.shape)
print("\nTÃªn cÃ¡c cá»™t:")
print(df.columns.tolist())
print("\n5 dÃ²ng Ä‘áº§u tiÃªn:")
print(df.head())

# Kiá»ƒm tra kiá»ƒu dá»¯ liá»‡u
print("\nğŸ“‹ Kiá»ƒu dá»¯ liá»‡u cá»§a cÃ¡c cá»™t:")
print(df.dtypes)

# Kiá»ƒm tra dá»¯ liá»‡u categorical
print("\nğŸ” Kiá»ƒm tra dá»¯ liá»‡u categorical:")
for col in df.columns:
    if df[col].dtype == 'object':
        print(f"{col}: {df[col].unique()}")

# Kiá»ƒm tra tÃªn cá»™t target - thÆ°á»ng lÃ  cá»™t cuá»‘i cÃ¹ng
target_column = df.columns[-1]  # Láº¥y cá»™t cuá»‘i cÃ¹ng
print(f"\nğŸ¯ Cá»™t target Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh: '{target_column}'")

# Táº¡o báº£n sao Ä‘á»ƒ xá»­ lÃ½
df_processed = df.copy()

# Xá»­ lÃ½ dá»¯ liá»‡u categorical báº±ng Label Encoding
label_encoders = {}
categorical_columns = []

for col in df_processed.columns:
    if df_processed[col].dtype == 'object':
        categorical_columns.append(col)
        le = LabelEncoder()
        df_processed[col] = le.fit_transform(df_processed[col])
        label_encoders[col] = le
        print(f"âœ… ÄÃ£ encode cá»™t '{col}': {dict(zip(le.classes_, le.transform(le.classes_)))}")

print(f"\nğŸ“ CÃ¡c cá»™t categorical Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½: {categorical_columns}")

# TÃ¡ch biáº¿n Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra
X = df_processed.drop(target_column, axis=1)
y = df_processed[target_column]

print(f"\nğŸ“ˆ KÃ­ch thÆ°á»›c dá»¯ liá»‡u sau khi xá»­ lÃ½:")
print(f"X (features): {X.shape}")
print(f"y (target): {y.shape}")
print(f"PhÃ¢n bá»‘ target: \n{y.value_counts()}")

# Kiá»ƒm tra dá»¯ liá»‡u sau khi xá»­ lÃ½
print(f"\nğŸ” Kiá»ƒm tra dá»¯ liá»‡u sau xá»­ lÃ½:")
print("Kiá»ƒu dá»¯ liá»‡u X:")
print(X.dtypes)
print("\n5 dÃ²ng Ä‘áº§u cá»§a X:")
print(X.head())

# Chia train/test
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42, stratify=y
)

print(f"\nğŸ“‚ Chia dá»¯ liá»‡u:")
print(f"Training set: {X_train.shape[0]} samples")
print(f"Test set: {X_test.shape[0]} samples")

# Huáº¥n luyá»‡n model
print("\nğŸ¤– Äang huáº¥n luyá»‡n model...")
model = RandomForestClassifier(
    n_estimators=100,
    random_state=42,
    max_depth=10
)
model.fit(X_train, y_train)

# ÄÃ¡nh giÃ¡ model
y_pred = model.predict(X_test)
accuracy = accuracy_score(y_test, y_pred)

print(f"\nğŸ“Š Káº¿t quáº£ Ä‘Ã¡nh giÃ¡:")
print(f"Accuracy: {accuracy:.4f}")
print(f"\nClassification Report:")
print(classification_report(y_test, y_pred))

# LÆ°u model vÃ  cÃ¡c thÃ´ng tin cáº§n thiáº¿t
model_filename = "heart_disease_model.pkl"
joblib.dump(model, model_filename)

# LÆ°u thÃ´ng tin vá» features vÃ  label encoders
feature_names = X.columns.tolist()
joblib.dump(feature_names, "feature_names.pkl")
joblib.dump(label_encoders, "label_encoders.pkl")

print(f"\nâœ… ÄÃ£ train vÃ  lÆ°u model thÃ nh cÃ´ng!")
print(f"ğŸ“ Model Ä‘Æ°á»£c lÆ°u táº¡i: {model_filename}")
print(f"ğŸ“ Feature names Ä‘Æ°á»£c lÆ°u táº¡i: feature_names.pkl")
print(f"ğŸ“ Label encoders Ä‘Æ°á»£c lÆ°u táº¡i: label_encoders.pkl")

# Hiá»ƒn thá»‹ Ä‘á»™ quan trá»ng cá»§a cÃ¡c features
print(f"\nğŸ” Äá»™ quan trá»ng cá»§a cÃ¡c features:")
feature_importance = pd.DataFrame({
    'feature': feature_names,
    'importance': model.feature_importances_
}).sort_values('importance', ascending=False)

for idx, row in feature_importance.iterrows():
    print(f"{row['feature']}: {row['importance']:.4f}")

# Test thá»­ model vá»›i má»™t sample
print(f"\nğŸ§ª Test model vá»›i má»™t sample ngáº«u nhiÃªn:")
sample_idx = 0
sample_input = X_test.iloc[sample_idx:sample_idx+1]
prediction = model.predict(sample_input)[0]
actual = y_test.iloc[sample_idx]
probability = model.predict_proba(sample_input)[0]

print(f"Input features: {sample_input.values[0]}")
print(f"Prediction: {prediction} ({'CÃ³ bá»‡nh tim' if prediction == 1 else 'KhÃ´ng bá»‡nh tim'})")
print(f"Actual: {actual} ({'CÃ³ bá»‡nh tim' if actual == 1 else 'KhÃ´ng bá»‡nh tim'})")
print(f"Probability [KhÃ´ng bá»‡nh, CÃ³ bá»‡nh]: [{probability[0]:.4f}, {probability[1]:.4f}]")
print(f"Correct: {'âœ…' if prediction == actual else 'âŒ'}")

print(f"\nğŸ‰ HoÃ n thÃ nh!")

# Táº¡o hÃ m Ä‘á»ƒ dá»± Ä‘oÃ¡n vá»›i dá»¯ liá»‡u má»›i
def predict_heart_disease(age, sex, chest_pain_type, resting_bp, cholesterol,
                         fasting_bs, resting_ecg, max_hr, exercise_angina,
                         oldpeak, st_slope):
    """
    HÃ m dá»± Ä‘oÃ¡n bá»‡nh tim vá»›i input má»›i

    Parameters:
    - age: tuá»•i
    - sex: giá»›i tÃ­nh ('M' hoáº·c 'F')
    - chest_pain_type: loáº¡i Ä‘au ngá»±c ('ATA', 'NAP', 'ASY', 'TA')
    - resting_bp: huyáº¿t Ã¡p nghá»‰
    - cholesterol: cholesterol
    - fasting_bs: Ä‘Æ°á»ng huyáº¿t lÃºc Ä‘Ã³i (0 hoáº·c 1)
    - resting_ecg: ECG nghá»‰ ('Normal', 'ST', 'LVH')
    - max_hr: nhá»‹p tim tá»‘i Ä‘a
    - exercise_angina: Ä‘au tháº¯t ngá»±c khi táº­p ('Y' hoáº·c 'N')
    - oldpeak: oldpeak
    - st_slope: Ä‘á»™ dá»‘c ST ('Up', 'Flat', 'Down')
    """

    # Táº¡o input DataFrame
    input_data = pd.DataFrame({
        'Age': [age],
        'Sex': [sex],
        'ChestPainType': [chest_pain_type],
        'RestingBP': [resting_bp],
        'Cholesterol': [cholesterol],
        'FastingBS': [fasting_bs],
        'RestingECG': [resting_ecg],
        'MaxHR': [max_hr],
        'ExerciseAngina': [exercise_angina],
        'Oldpeak': [oldpeak],
        'ST_Slope': [st_slope]
    })

    # Ãp dá»¥ng label encoding cho cÃ¡c cá»™t categorical
    for col in categorical_columns:
        if col in input_data.columns and col in label_encoders:
            try:
                input_data[col] = label_encoders[col].transform(input_data[col])
            except ValueError as e:
                print(f"Lá»—i: GiÃ¡ trá»‹ '{input_data[col].iloc[0]}' khÃ´ng cÃ³ trong training data cho cá»™t '{col}'")
                return None

    # Dá»± Ä‘oÃ¡n
    prediction = model.predict(input_data)[0]
    probability = model.predict_proba(input_data)[0]

    result = {
        'prediction': prediction,
        'prediction_text': 'CÃ³ bá»‡nh tim' if prediction == 1 else 'KhÃ´ng bá»‡nh tim',
        'probability_no_disease': probability[0],
        'probability_disease': probability[1]
    }

    return result

print(f"\nğŸ“‹ HÆ°á»›ng dáº«n sá»­ dá»¥ng hÃ m predict_heart_disease:")
print("VÃ­ dá»¥: predict_heart_disease(40, 'M', 'ATA', 140, 289, 0, 'Normal', 172, 'N', 0, 'Up')")

# Test hÃ m predict
print(f"\nğŸ§ª Test hÃ m predict vá»›i dá»¯ liá»‡u máº«u:")
test_result = predict_heart_disease(40, 'M', 'ATA', 140, 289, 0, 'Normal', 172, 'N', 0, 'Up')
if test_result:
    print(f"Káº¿t quáº£ dá»± Ä‘oÃ¡n: {test_result}")