# CÃ i thÆ° viá»‡n cáº§n thiáº¿t (náº¿u chÆ°a cÃ³)
!pip install scikit-learn pandas joblib

# Import
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import accuracy_score, classification_report
import joblib

# Táº£i dataset tá»« URL
url = "https://raw.githubusercontent.com/selva86/datasets/master/PimaIndiansDiabetes.csv"
df = pd.read_csv(url)

# Kiá»ƒm tra cáº¥u trÃºc cá»§a dataset
print("ğŸ“Š ThÃ´ng tin vá» dataset:")
print("KÃ­ch thÆ°á»›c:", df.shape)
print("\nTÃªn cÃ¡c cá»™t:")
print(df.columns.tolist())
print("\n5 dÃ²ng Ä‘áº§u tiÃªn:")
print(df.head())

# Kiá»ƒm tra tÃªn cá»™t target - thÆ°á»ng lÃ  cá»™t cuá»‘i cÃ¹ng
target_column = df.columns[-1]  # Láº¥y cá»™t cuá»‘i cÃ¹ng
print(f"\nğŸ¯ Cá»™t target Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh: '{target_column}'")

# TÃ¡ch biáº¿n Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra
X = df.drop(target_column, axis=1)
y = df[target_column]

print(f"\nğŸ“ˆ KÃ­ch thÆ°á»›c dá»¯ liá»‡u:")
print(f"X (features): {X.shape}")
print(f"y (target): {y.shape}")
print(f"PhÃ¢n bá»‘ target: \n{y.value_counts()}")

# Chia train/test
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42, stratify=y
)

print(f"\nğŸ“‚ Chia dá»¯ liá»‡u:")
print(f"Training set: {X_train.shape[0]} samples")
print(f"Test set: {X_test.shape[0]} samples")

# Huáº¥n luyá»‡n model
print("\nğŸ¤– Äang huáº¥n luyá»‡n model...")
model = RandomForestClassifier(
    n_estimators=100,
    random_state=42,
    max_depth=10
)
model.fit(X_train, y_train)

# ÄÃ¡nh giÃ¡ model
y_pred = model.predict(X_test)
accuracy = accuracy_score(y_test, y_pred)

print(f"\nğŸ“Š Káº¿t quáº£ Ä‘Ã¡nh giÃ¡:")
print(f"Accuracy: {accuracy:.4f}")
print(f"\nClassification Report:")
print(classification_report(y_test, y_pred))

# LÆ°u model
model_filename = "diabetes_model.pkl"
joblib.dump(model, model_filename)

# LÆ°u thÃ´ng tin vá» features Ä‘á»ƒ sá»­ dá»¥ng sau nÃ y
feature_names = X.columns.tolist()
joblib.dump(feature_names, "feature_names.pkl")

print(f"\nâœ… ÄÃ£ train vÃ  lÆ°u model thÃ nh cÃ´ng!")
print(f"ğŸ“ Model Ä‘Æ°á»£c lÆ°u táº¡i: {model_filename}")
print(f"ğŸ“ Feature names Ä‘Æ°á»£c lÆ°u táº¡i: feature_names.pkl")

# Hiá»ƒn thá»‹ Ä‘á»™ quan trá»ng cá»§a cÃ¡c features
print(f"\nğŸ” Äá»™ quan trá»ng cá»§a cÃ¡c features:")
feature_importance = pd.DataFrame({
    'feature': feature_names,
    'importance': model.feature_importances_
}).sort_values('importance', ascending=False)

for idx, row in feature_importance.iterrows():
    print(f"{row['feature']}: {row['importance']:.4f}")

# Test thá»­ model vá»›i má»™t sample
print(f"\nğŸ§ª Test model vá»›i má»™t sample ngáº«u nhiÃªn:")
sample_idx = 0
sample_input = X_test.iloc[sample_idx:sample_idx+1]
prediction = model.predict(sample_input)[0]
actual = y_test.iloc[sample_idx]
probability = model.predict_proba(sample_input)[0]

print(f"Input: {sample_input.values[0]}")
print(f"Prediction: {prediction}")
print(f"Actual: {actual}")
print(f"Probability: {probability}")
print(f"Correct: {'âœ…' if prediction == actual else 'âŒ'}")

print(f"\nğŸ‰ HoÃ n thÃ nh!")